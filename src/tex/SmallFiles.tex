\documentclass[a4paper,8pt]{scrartcl}

\usepackage{fontspec}
% \setromanfont{Linux Libertine Display}
\usepackage{xunicode}
\usepackage{polyglossia}
\usepackage{german}
\RequirePackage{graphicx}

\title{Support for small file for dCache}
\date{13/08/13}

\begin{document}
\titlepage

\section{Introduction}
This article describes a simple way to use \emph{dCache} to efficiently store
and retrieve small files on tertiary storage systems. To avoid the overhead of
writing every file of a series by itself, we developed a set of scripts that
will add a layer of abstraction to transparently bundle the files and store them
together in an archive. This only requires minimal configuration and can be used
with any dCache version 2.6.3 and higher.

\subsection{Requirements}
The required configuration to use the scripts are a working \emph{dCache}
version 2.6.3 or higher installation. The pools that store the small files have
to be configured with \texttt{lfs=none} and they need to be able to access the
\emph{Chimera} DB using \texttt{psql}. Their size should be big enough to store
all the new files for at least one day. They need to have the \texttt{dcap}
libraries installed. 

The work station that produces the files needs to mount \emph{Chimera} via
\emph{NFS4.1}.

\section{Installation}
To install the Small Files capabilities do

\subsection{In the namespace}
\begin{enumerate}
  \item create a directory to be used by the scripts (e.g. \texttt{hsm})
  \item create two subdirectories to the \texttt{hsm}-directory called \texttt{archives} and \texttt{requests}
  \item on \texttt{archives} set \texttt{AccessLatency} to \texttt{NEARLINE} and \texttt{RetentionPolicy} to \texttt{CUSTODIAL}
  \item on \texttt{requests} set \texttt{AccessLatency} to \texttt{ONLINE} and \texttt{RetentionPolicy} to \texttt{REPLICA}
\end{enumerate}

\subsection{On the NFS4.1 door}
\begin{enumerate}
  \item add the file producing node to the \texttt{/etc/dcache/exports} with
    \texttt{rw,no\_root\_squash} access rights
\end{enumerate}

\subsection{On the pool node}
\begin{enumerate}
  \item install dcap libraries (\texttt{yum install dcap} on the console)
  \item install the scala-library 2.10 by copying scala-library.jar to \texttt{/usr/local/lib/}
  \item install nailgun client and server by copying \texttt{ng} and \texttt{nailgun-server-0.9.2-SNAPSHOT.jar} to \texttt{/usr/local/bin/}
  \item install the ScalaChimeraNailgun library by copying it to \texttt{/usr/local/lib/}
  \item configure the symlinks to ng (e.g., \texttt{ln -s /usr/local/bin/ng /usr/local/bin/cpathof})
  \item start the nailgun server (\texttt{/usr/local/bin/runNailgunServer.sh})
  \item configure the aliases for the nailgun server (\texttt{e.g., ng ng-alias cpathof}, this is done by loadChimaNailgun.sh)
  \item edit \texttt{hsm-internal.sh} script to contain the correct \texttt{CHIMERA\_PARAMS}
  \item edit \texttt{hsm-internal.sh} script to use a suitable log-file. Note: The script runs as the configured \emph{dCache}-User.
  \item set lfs to none (\texttt{lfs=none} in layout file)
  \item set max storage handlers to 2 or higher (max 10) (\texttt{st set max active 2} in admin interface)
  \item set max restore handlers to 2 or higher (\texttt{rh set max active 2} in admin interface)
  \item configure the HSM \texttt{dcache} for your site on the pool in the admin interface
    \subitem[\texttt{hsmBase}] \texttt{hsm set dcache -hsmBase=hsm}
    \subitem[\texttt{command}] \texttt{hsm set dcache -command=/usr/share/dcache/lib/hsm-internal.sh}
    \subitem[\texttt{dataRoot}] \texttt{hsm set dcache -dataRoot=/data}
    % \subitem[chimeraArgs] \texttt{hsm set dcache chimeraArgs="org.postgresql.Driver jdbc:postgresql://dcache-lab000/chimera?prepareThreshold=3 PgSQL chimera - "
\end{enumerate}

\subsection{On the file producing node}
\begin{enumerate}
  \item mount the NFS namespace to a local directory (e.g. \texttt{/pnfs/4})
  \item on the directories used to store the small files set the tags
    \subitem[\texttt{hsmInstance}] to \texttt{dcache}
    \subitem[\texttt{OSMTemplate}] to \texttt{StoreName <data>}, arbitrary but neccessary, e.g., \texttt{archived}
    \subitem[\texttt{sGroup}] to \texttt{<sGroup>}, arbitrary but neccessary, e.g., \texttt{smallfiles}
\end{enumerate}

\subsection{On the packing node}
\begin{enumerate}
  \item mount the NFS namespace to a local directory (e.g. \texttt{/pnfs/4})
  \item install the packing script (\texttt{pack-files.sh}) into your path
  \item install a cron job that calls the packing script. E.g., 
    \subitem \texttt{*  *  *  *  * root /usr/share/dcache/lib/pack-files.sh <dataRoot> <pnfsMountpoint> <hsmSubdir> <archiveSize> 2>\&1}
    \subitem where <dataRoot> is the pnfs path prefix. E.g., \texttt{/data} or \texttt{/exports/data}
    \subitem <pnfsMountpoint> is the local mountpoint of the namespace. E.g., \texttt{/pnfs/4}
    \subitem <hsmSubdir> is the directory name containing the \texttt{archives} and \texttt{requests} directories (s.a.). E.g., \texttt{hsm}
    \subitem <archiveSize> is the approximate size of the archives in bytes
\end{enumerate}

\section{Implementation} 
The implementation in its current form consists of two scripts, namely
\texttt{hsm-internal.sh} and \texttt{pack-files.sh}. The first script is called
for every file and creates a flag that is later used by the second script to
bundle the files together. Only files residing in the same (sub-)directory will 
be bundled together.

After configuration the \texttt{dCache} pools call \texttt{hsm-internal.sh} for 
every file of \emph{OSM} type \texttt{dcache}. The \texttt{hsm-internal} script
has two commands: \texttt{put} and \texttt{get}. As soon as a new file for OSM
type \texttt{dcache} arrives at a pool, the script is called with the command 
\texttt{put}. This checks If it does not exist yet, the script will create sub-directories under 

\section{Statistics}
The statistics were created using the following machines:
\begin{itemize}
  \item \texttt{dcache-lab000} as \emph{dCache} head node with \emph{NFS4.1} door
  \item \texttt{dcache-lab001} as pool node (only in multiple pools runs)
  \item \texttt{dcache-lab002} as pool node
  \item \texttt{st set max active 2}
  \item \texttt{christian-vm01} to inject small files and to periodically (1/min) run the \texttt{pack-files.sh}
\end{itemize}

\subsection{Writing files in 1 pool}

\begin{tabular}{|r||r||r|}
  \hline
  file size & file count & time \\
  \hline
  1k & 1000 &  \\
  \hline
  1k & 2000 &  \\
  \hline
  1k & 4000 &\\
  \hline
  1k & 10000 &\\
  \hline
  1k & 20000 &\\
  \hline
  1k & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  file size & file count & time \\
  2k & 1000 & \\
  \hline
  2k & 2000 &\\
  \hline
  2k & 4000 &\\
  \hline
  2k & 10000 &\\
  \hline
  2k & 20000 &\\
  \hline
  2k & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  4k & 1000 & \\
  \hline
  4k & 2000 &\\
  \hline
  4k & 4000 &\\
  \hline
  4k & 10000 &\\
  \hline
  4k & 20000 &\\
  \hline
  4k & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  8k & 1000 & \\
  \hline
  8k & 2000 &\\
  \hline
  8k & 4000 &\\
  \hline
  8k & 10000 &\\
  \hline
  8k & 20000 &\\
  \hline
  8k & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  40k & 1000 & \\
  \hline
  40k & 2000 &\\
  \hline
  40k & 4000 &\\
  \hline
  40k & 10000 &\\
  \hline
  40k & 20000 &\\
  \hline
  40k & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  1M & 1000 & \\
  \hline
  1M & 2000 &\\
  \hline
  1M & 4000 &\\
  \hline
  1M & 10000 &\\
  \hline
  1M & 20000 &\\
  \hline
  1M & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  2M & 1000 & \\
  \hline
  2M & 2000 &\\
  \hline
  2M & 4000 &\\
  \hline
  2M & 10000 &\\
  \hline
  2M & 20000 &\\
  \hline
  2M & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  4M & 1000 & \\
  \hline
  4M & 2000 &\\
  \hline
  4M & 4000 &\\
  \hline
  4M & 10000 &\\
  \hline
  4M & 20000 &\\
  \hline
  4M & 100000 &\\
  \hline
\end{tabular}

\begin{tabular}{|r||r||r|}
  \hline
  8M & 1000 & \\
  \hline
  8M & 2000 &\\
  \hline
  8M & 4000 &\\
  \hline
  8M & 10000 &\\
  \hline
  8M & 20000 &\\
  \hline
  8M & 100000 &\\
  \hline
\end{tabular}


\subsection{Writing 9k files in 1 pool evenly distributed into 9 directories}

\begin{tabular}{|r||r||r|r|r|}
  \hline
  file size & write files  & archive 20 & archive 100 & archive 1000 \\
  \hline
  1k        &  9min (16/sec)  & 70min (2.1/sec) & 29min (5/sec) & 27min (5.5/sec) \\
  \hline
  1M        & 18min (8/sec)   &        -        & 34min (4.4/sec) & 32min (4.6/sec) \\
  \hline
  5M        & 29min (5.1/sec) &        -        & 40min (3.7/sec) & 40min (3.7/sec) \\
  \hline
  10M       & 39min (3.8/sec) &        -        & 57min (2.6/sec) & ??? \\
  \hline
\end{tabular}

\subsection{Writing 90k files in 1 pool evenly distributed into 9 directories}

\begin{tabular}{|r||r||r|r|r|r|}
  \hline
  file size & write files  & archive 500 & archive 1000 & archive 2000 & archive 10000 \\
  \hline
  5M        & 312min (4.7/sec) & ??? & ??? & 368min (4.1/sec) & >8h \\
  5M        & 340min (4.4/sec) & ??? & ??? & 368min (4.1/sec) & >8h \\
  5M        & 325min (4.6/sec) & ??? & ??? & 368min (4.1/sec) & >8h \\
  \hline
  10M       & ??? & ??? & ??? & ??? & ??? \\
  \hline
\end{tabular}

\subsection{Writing 90k files in 2 pools}

\begin{tabular}{|r||r||r|r|r|r|}
  \hline
  file size & write files  & archive 500 & archive 1000 & archive 2000 & archive 10000 \\
  \hline
  5M        & ??? & ??? & ??? & ??? & ??? \\
  \hline
  10M       & ??? & ??? & ??? & ??? & ??? \\
  \hline
\end{tabular}

\subsection{Writing 90k files in 1 pool evenly distributed into 3 directories}
\begin{tabular}{|r||r||r|r|r|r|}
  \hline
  file size & write files  & archive 100 & archive 1000 & archive 2000 & archive 10000 \\
  \hline
  1k        & 327min (4.6/min) & ca. 600min & ??? & ??? & ??? \\
  \hline
  1M        & ??? & ??? & ??? & ??? & ??? \\
  \hline
  5M        & ??? & ??? & ??? & ??? & ??? \\
  \hline
  10M       & ??? & ??? & ??? & ??? & ??? \\
  \hline
\end{tabular}

\subsection{Writing 90k files in 1 pool evenly distributed into 90 directories}

\begin{tabular}{|r||r||r|}
  \hline
  file size & write files  & archive 1000 \\
  \hline
  5M        & 390min (3.8/sec) & 410min (3.6/sec) \\
  \hline
\end{tabular}

\subsection{Writing 100k files in 1 pool evenly distributed into 2 directories}

\begin{tabular}{|r||r||r|}
  \hline
  file size & write files  & archive 1000 \\
  \hline
  5M        & 282 (5.9/sec) & 410min (3.6/sec) \\
  \hline
\end{tabular}

\subsection{Archiving 5M files from 1 pool}

\begin{tabular}{|r|r||r|}
  \hline
  file size & files  & time archiving + writing levels \\
  \hline
  5M        & 10000 & 30min + 2min \\
  \hline
  5M        & 40000 & 110min + 11min \\
  \hline
\end{tabular}
This took 1h 40min. Writing the levels took another 20mins.

Retrieving a file from an archive (using dcap) takes about 3s.

\section{Optimizing parameters}
\begin{itemize}
  \item The more subdirectories are used, the more parallel the archivation can
    be.
  \item The more pools are involved, the faster can the flag files be created
    and removed - provided the DB is not the bottleneck.
  \item The interval of running the packing script (\texttt{pack-files.sh})
    should match the time it takes to create as many flags as files are
    expected to go into one archive.
  \item The size of the archives should be chosen so that the time for creating
    an archive matches the run interval of the packing script.
\end{itemize}


\section{Problems and their effects}

\subsection{No space left on device}
If the normal filesystem on a pool runs out of space, the
\texttt{hsm-internal.sh} script will fail because it cannot write its logs and
cause the flagfiles not to be created or removed.

\subsection{Operations in the NFS4.1 mount hang}
If the log of the nfs door shows: \texttt{FATAL: remaining connection slots are
reserved for non-replication superuser connections}, it means that dCache has
used up all free DB connection slots. 
This will cause any file operation on the NFS mount to fail and thus make the
packing stop working.

\section{Outlook}

\subsection{Installer}
Create an installer to easily install the scripts, nailgun and the chimera nails.

\subsection{Possible enhancements}
\begin{itemize}
  \item Chimera parameters on hsm level instead of hardcoded in the script
  \item Optionally bundle subdirectories into one archive
  \item Archive size per directory
  \item Unpack all files from archive instead of only requested
  \item Archive by file count or specify file size to improve performance
  \item Specify min and max size of archive
  \item Recovery: Check if the pid of the lockfile still exists and if it
    doesn't clear the lock
  \item Verify archive integrity further by using checksums or \texttt{tar
    -d[hf] arc.tar /tmp/links/*}
    \subitem checksums, sums of checksum(?)
    \subitem \texttt{tar cWhf arc.tar /tmp/links/*} - this takes much longer
    (factor 3 on a desktop machine)
    \subitem \texttt{tar -dhf arc.tar /tmp/links/*} - takes about the same time
    as \texttt{W}
  \item Have different scripts with different parameters for different
    directories
\end{itemize}

\section{Remaining problems}

\subsection{interrupting pack-files.sh while collecting files.}
This may cause the machine to crash.

\subsection{file input stream pauses}
Sometimes dCache refuses to accept more files for a couple of seconds
\end{document}
